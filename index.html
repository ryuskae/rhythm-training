<!doctype html><html lang="ko"><head><meta charset="utf-8"/><meta name="viewport" content="width=device-width,initial-scale=1"/><meta name="color-scheme" content="light"/><title>Rhythm Quiz (OSMD, HTML+JS)</title><style>body{margin:0;background:#fff;font-family:system-ui,-apple-system,Segoe UI,Roboto,sans-serif}#app{padding:14px;max-width:960px;margin:0 auto}.tb{display:flex;gap:8px;align-items:center;flex-wrap:wrap;margin:0 0 12px}.b{padding:8px 12px;border:1px solid #d1d5db;border-radius:10px;background:#fff;cursor:pointer}.b.a{background:#1e90ff;color:#fff;border-color:#1e90ff}.card{border:1px solid #e5e7eb;border-radius:12px;box-shadow:0 2px 8px rgba(0,0,0,.04);padding:12px;background:#fff}.opt{display:flex;align-items:center;gap:10px;border:1px solid #e5e7eb;border-radius:10px;padding:10px;margin:6px 0;background:#fafafa}.opt .p{padding:6px 10px;border:1px solid #d1d5db;border-radius:8px;background:#fff;cursor:pointer}.ok{outline:2px solid #22c55e;background:#f0fff4}.bad{outline:2px solid #ef4444;background:#fff1f2}.lab{min-width:28px;text-align:center;font-weight:600}.host{width:100%;min-height:56px;overflow:hidden;background:#fff;border-radius:6px}.hide{display:none}#res{margin:10px 4px;min-height:28px;font-weight:700;color:#2563eb}</style><script src="https://cdn.jsdelivr.net/npm/opensheetmusicdisplay@1.9.2/build/opensheetmusicdisplay.min.js"></script></head><body><div id="app"><div class="tb"><button id="unlock" class="b">🔊 오디오</button><span>난이도:</span><button class="b d" data-sd="4">4비트</button><button class="b d a" data-sd="8">8비트</button><button class="b d" data-sd="16">16비트</button><button id="newq" class="b">새 문제</button><span style="margin-left:8px">BPM</span><input id="bpm" type="number" min="40" max="200" value="84" style="width:64px;padding:6px;border:1px solid #d1d5db;border-radius:8px"/></div><h3>문제</h3><div class="card"><div id="q" class="host"></div></div><div id="res"></div><h3 style="margin-top:14px">보기</h3><div id="ops"></div></div><script>"use strict";const S={reveal:false,sd:8,tok:0,lock:false},A={ctx:null,master:null,bpm:84,stops:[]};const D=8,T=32,B=8;function au(){if(A.ctx)return;const c=new (window.AudioContext||window.webkitAudioContext)(),m=c.createGain();m.gain.value=.9;m.connect(c.destination);A.ctx=c;A.master=m}function stopAll(){while(A.stops.length){const s=A.stops.pop();try{s()}catch(e){}}}function tone(t,sec,f=261.626,pk=.35){const c=A.ctx;if(!c)return;const o=c.createOscillator(),g=c.createGain();o.type="sine";o.frequency.setValueAtTime(f,t);const a=.01,r=.04,s=.85;g.gain.setValueAtTime(.0008,t);g.gain.linearRampToValueAtTime(pk,t+a);g.gain.linearRampToValueAtTime(pk*s,t+Math.max(a,sec-r));g.gain.exponentialRampToValueAtTime(.0001,t+Math.max(a,sec-r)+r);o.connect(g).connect(A.master);o.start(t);const stopT=t+sec+.02,stop=()=>{try{o.stop(0)}catch(e){}};A.stops.push(stop);setTimeout(stop,Math.max(0,(stopT-c.currentTime)*1e3))}function tick(t,acc=false){tone(t,.04,acc?660:440,acc?.42:.3)}function seq(xml){try{const d=new DOMParser().parseFromString(xml,'application/xml'),divs=parseInt(d.querySelector('divisions')?.textContent||'8',10)||8,notes=[...d.getElementsByTagName('note')];const q=60/A.bpm;const out=[];let inTie=false,acc=0;const has=(n,sel)=>n.querySelector(sel)!==null;for(const n of notes){const dur=parseInt(n.getElementsByTagName('duration')[0]?.textContent||'0',10);const isRest=n.getElementsByTagName('rest').length>0;const tStart=has(n,'tie[type="start"], notations tied[type="start"]');const tStop =has(n,'tie[type="stop"],  notations tied[type="stop"]');const sec=(dur/divs)*q;if(isRest){ if(inTie&&acc>0){out.push({seconds:acc,isRest:false});acc=0;inTie=false} out.push({seconds:sec,isRest:true}); continue;} if(inTie){ acc+=sec; if(tStop){ out.push({seconds:acc,isRest:false}); acc=0; inTie=false; } } else { if(tStart){ inTie=true; acc=sec; if(tStop){ out.push({seconds:acc,isRest:false}); acc=0; inTie=false; } } else { out.push({seconds:sec,isRest:false}); } } } if(inTie&&acc>0) out.push({seconds:acc,isRest:false}); return out.length? out :[{seconds:q,isRest:false}]; }catch(e){const q=60/A.bpm;return[{seconds:q,isRest:false},{seconds:q,isRest:false},{seconds:q,isRest:false},{seconds:q,isRest:false}]}}async function renderInto(h,xml){h.innerHTML='';const C=(window.opensheetmusicdisplay&&window.opensheetmusicdisplay.OpenSheetMusicDisplay)||window.OpenSheetMusicDisplay;if(!C){h.innerHTML='<div style="padding:8px;font-size:12px;color:#6b7280">악보 엔진 로딩 중…</div>';return}try{const o=new C(h,{backend:'svg',autoResize:false,drawingParameters:'compacttight',drawTitle:false,drawComposer:false,drawSubtitle:false,drawPartNames:false,renderSingleHorizontalStaffline:true});await o.load(xml);await o.render();const norm=()=>{const s=h.querySelector('svg');if(!s)return{w:0,h:0};const bw=s.width?.baseVal?.value||s.getBoundingClientRect().width||1e3,bh=s.height?.baseVal?.value||s.getBoundingClientRect().height||300;if(!s.getAttribute('viewBox'))s.setAttribute('viewBox',`0 0 ${bw} ${bh}`);s.removeAttribute('width');s.removeAttribute('height');s.setAttribute('preserveAspectRatio','xMidYMid meet');s.style.background='#fff';return{w:s.viewBox?.baseVal?.width||bw,h:s.viewBox?.baseVal?.height||bh}};let fitting=false;const fit=async()=>{if(fitting)return;fitting=true;try{const {w}=norm(),W=h.clientWidth||0;if(w>0&&W>0){const z=Math.max(.2,Math.min(5,(W/w)*.995));if(Math.abs(o.Zoom-z)>.004){o.Zoom=z;await o.render();norm()}}}finally{fitting=false}};await fit();if(h.__ro){try{h.__ro.disconnect()}catch(e){}}let scheduled=false;const ro=new ResizeObserver(()=>{if(scheduled)return;scheduled=true;requestAnimationFrame(async()=>{scheduled=false;await fit()})});ro.observe(h);h.__ro=ro}catch(e){console.error(e);h.innerHTML='<div style="padding:8px;font-size:12px;color:#b91c1c;background:#fee2e2;border:1px solid #fecaca;border-radius:8px">악보 렌더 실패</div>'}}function typeByTicks(t){return t===32?'whole':t===24?'half':t===16?'half':t===12?'quarter':t===8?'quarter':t===6?'eighth':t===4?'eighth':'16th'}function mk(min){min=(min===4?8:min===8?4:min===16?2:min);const allow=(min===8?[8,16,24,32]:min===4?[4,8,16,24,32]:[2,4,6,8,12,16,24,32]);function wPick(a){const W=a.map(t=>Math.max(1,Math.floor((t*t)/4))),S=W.reduce((x,y)=>x+y,0);let r=Math.random()*S;for(let i=0;i<a.length;i++){r-=W[i];if(r<=0)return a[i]}return a[a.length-1]}const d=[min];let rem=T-min;const pref=allow.filter(t=>t>=16&&t<=24);if(pref.length){const p=pref[Math.floor(Math.random()*pref.length)];if(p<=rem){d.push(p);rem-=p}}let g=0;while(rem>0&&g++<999){const c=allow.filter(t=>t<=rem);if(!c.length){d[d.length-1]+=rem;rem=0;break}const pick=wPick(c);d.push(pick);rem-=pick}for(let i=d.length-1;i>0;i--){const j=Math.floor(Math.random()*(i+1));[d[i],d[j]]=[d[j],d[i]]}const minIdx=d.indexOf(min);const raw=d.map((t,i)=>({ticks:t,type:typeByTicks(t),dots:(t===6||t===12||t===24)?1:0,rest:false,_gid:Symbol()}));raw[minIdx].rest=false;function split(evts){const out=[];let pos=0;for(const ev of evts){if(!ev.rest&&ev.ticks===16&&(pos%8===0)&&((pos%32)===0||(pos%32)===16)){out.push({...ev,ticks:16,dots:0});pos+=16;continue}let r=ev.ticks,cp=pos,parts=[];while(r>0){const to=8-(cp%8),take=Math.min(r,to);parts.push({ticks:take,type:typeByTicks(take),dots:(take===6||take===12||take===24)?1:0,rest:ev.rest,_gid:ev._gid,tieStart:false,tieStop:false});r-=take;cp+=take}pos=cp;out.push(...parts)}let p=0;out.forEach(x=>{x.abs=p;p+=x.ticks});return out}let ev=split(raw);function retie(a){for(const x of a){x.tieStart=false;x.tieStop=false}let done=false;for(let i=0;i<a.length-1;i++){if(done)break;const cur=a[i],nxt=a[i+1];if(!cur.rest&&!nxt.rest&&cur._gid===nxt._gid){cur.tieStart=true;nxt.tieStop=true;done=true;}}}
function cramRests(a){let p=0;a.forEach(x=>{x.abs=p;p+=x.ticks});const out=[];for(let i=0;i<a.length;){const e=a[i];if(!e.rest){out.push(e);i++;continue}const bs=e.abs-(e.abs%8),be=bs+8;let j=i,sum=0;while(j<a.length){const z=a[j];if(!z.rest||z.abs>=be)break;sum+=z.ticks;j++}if(bs===0||bs===16){const end=bs+16;let acc=0;for(let k=i;k<a.length;k++){const z=a[k];if(!z.rest||z.abs>=end)break;acc+=z.ticks}if(acc===16){out.push({ticks:16,type:'half',dots:0,rest:true});i=j;continue}}while(sum>=8){out.push({ticks:8,type:'quarter',dots:0,rest:true});sum-=8}if(sum>0)out.push({ticks:sum,type:typeByTicks(sum),dots:(sum===6)?1:0,rest:true});i=j}let q=0;out.forEach(x=>{x.abs=q;q+=x.ticks});return out}ev=cramRests(ev);retie(ev);function beam(a){let p=0;a.forEach(x=>{x.abs=p;x.bi=Math.floor(p/8);p+=x.ticks});const gs=[];for(let i=0;i<a.length;){if(!a[i].rest&&a[i].ticks<8){const b=a[i].bi,g=[i];let s=a[i].ticks;i++;while(i<a.length&&a[i].bi===b&&!a[i].rest&&a[i].ticks<8&&(s+a[i].ticks)<=8){g.push(i);s+=a[i].ticks;i++}if(g.length>1)gs.push(g)}else i++}function f4(st){const ed=st+16;const idx=a.map((e,ix)=>({ix,e})).filter(o=>!o.e.rest&&o.e.ticks===4&&o.e.abs>=st&&(o.e.abs+o.e.ticks)<=ed).map(o=>o.ix);for(let s=0;s+3<idx.length;s++){const t=idx.slice(s,s+4),cont=t.every((ix,k)=>k===0||ix===t[k-1]+1);if(cont){gs.push(t);return}}}f4(0);f4(16);const tag=Array(a.length).fill(null);for(const g of gs){if(g.length<2)continue;tag[g[0]]='begin';for(let j=1;j<g.length-1;j++)tag[g[j]]='continue';tag[g[g.length-1]]='end'}a.forEach((e,i)=>e.beam=tag[i]);return a}beam(ev);function ensureMinNote(events,req){if(events.some(e=>!e.rest&&e.ticks===req))return events;const idx=events.findIndex(e=>e.ticks>=8&&(e.abs%8)+req<=8);if(idx>=0){const e=events[idx];const head={...e,rest:false,ticks:req,dots:(req===6||req===12||req===24)?1:0,tieStart:false,tieStop:false};const tailTicks=e.ticks-req;if(tailTicks>0){const tail={...e,ticks:tailTicks,tieStart:false,tieStop:false};events.splice(idx,1,head,tail);}else{events.splice(idx,1,head);}}else{const e0=events[0];const diff=e0.ticks-req;if(diff>0){events[0]={...e0,rest:false,ticks:req,tieStart:false,tieStop:false};events.splice(1,0,{...e0,ticks:diff});}else{events[0]={...e0,rest:false,ticks:req};}}let p=0;events.forEach(x=>{x.abs=p;p+=x.ticks});return events}function fixTotal32(events){let total=events.reduce((a,b)=>a+b.ticks,0);if(total===32)return events;if(total>32){let cut=total-32;for(let i=events.length-1;i>=0&&cut>0;i--){const can=Math.min(cut,events[i].ticks);events[i].ticks-=can;cut-=can;if(events[i].ticks===0)events.splice(i,1)}}else{let add=32-total;while(add>0){const take=add>=8?8:add>=4?4:2;events.push({ticks:take,type:typeByTicks(take),dots:(take===6)?1:0,rest:true,tieStart:false,tieStop:false});add-=take}}let p=0;events.forEach(x=>{x.abs=p;p+=x.ticks});return events}const req=(min===8?8:min===4?4:2);ev=ensureMinNote(ev,req);ev=fixTotal32(ev);retie(ev);const nx=ev.map(e=>{const tp=typeByTicks(e.ticks),dot=e.dots?'<dot/>' :'',bm=e.beam?`<beam number="1">${e.beam}</beam>`:'';if(e.rest)return`<note><rest/><duration>${e.ticks}</duration><type>${tp}</type>${dot}${bm}</note>`;const ts=e.tieStart?'<tie type="start"/>':'',te=e.tieStop?'<tie type="stop"/>':'',nt=(e.tieStart||e.tieStop)?`<notations>${e.tieStart?'<tied type="start"/>':''}${e.tieStop?'<tied type="stop"/>':''}</notations>`:'';return`<note>${ts}<pitch><step>C</step><octave>4</octave></pitch><duration>${e.ticks}</duration><type>${tp}</type>${dot}${bm}${nt}${te}<stem>up</stem></note>`}).join('');return`<?xml version="1.0" encoding="UTF-8"?><score-partwise version="3.1"><part-list><score-part id="P1"><part-name>R</part-name></score-part></part-list><part id="P1"><measure number="1"><attributes><divisions>${D}</divisions><time><beats>4</beats><beat-type>4</beat-type></time><clef><sign>G</sign><line>2</line></clef></attributes>${nx}</measure></part></score-partwise>`}function sig(xml){try{const d=new DOMParser().parseFromString(xml,'application/xml');return[...d.getElementsByTagName('note')].map(n=>parseInt(n.getElementsByTagName('duration')[0]?.textContent||'0',10)).join(',')}catch(e){return''}}function newQ(){if(S.lock)return;S.lock=true;const tk=++S.tok,sd=S.sd,q=mk(sd),k=sig(q),ds=[],u=new Set([k]);let tries=0;while(ds.length<4&&tries++<200){const x=mk(sd),s=sig(x);if(s!==k&&!u.has(s)){ds.push(x);u.add(s)}}while(ds.length<4)ds.push(mk(sd));const opts=ds.slice(),ci=Math.floor(Math.random()*5);opts.splice(ci,0,q);if(opts.length>5)opts.length=5;document.getElementById('q').innerHTML='';document.getElementById('ops').innerHTML='';document.getElementById('res').textContent='';setProblem(q,opts,ci,tk);S.lock=false}async function play(xml,host){au();try{await A.ctx.resume()}catch(e){}stopAll();const v=document.getElementById('bpm'),b=Math.max(40,Math.min(200,parseInt(v.value||A.bpm,10)||A.bpm));A.bpm=b;const c=A.ctx,t0=c.currentTime+.05,s=seq(xml);let acc=0;for(const ev of s){if(!ev.isRest)tone(t0+acc,ev.seconds,261.626,.36);acc+=ev.seconds}for(let i=0;i<4;i++)tick(t0+i*(60/A.bpm),i===0);if(S.reveal){[...document.querySelectorAll('#ops .host')].forEach(el=>{if(el!==host){el.classList.add('hide');el.innerHTML=''}});if(host.classList.contains('hide')){await renderInto(host,xml);host.classList.remove('hide')}}}window.setProblem=async(qXML,opts,ci,tk)=>{const my=tk??(++S.tok);S.reveal=false;await renderInto(document.getElementById('q'),qXML);if(my!==S.tok)return;const wrap=document.getElementById('ops');wrap.innerHTML='';const res=document.getElementById('res');res.textContent='';let answered=false,nextBtn=null;opts.forEach((xml,i)=>{const row=document.createElement('div');row.className='opt';const lab=document.createElement('div');lab.className='lab';lab.textContent=(i+1)+'.';const btn=document.createElement('button');btn.className='p';btn.textContent='▶︎ 듣기';const host=document.createElement('div');host.className='host hide';host.id='o_'+i;const mark=document.createElement('div');mark.style.marginLeft='auto';mark.style.fontWeight='700';mark.style.minWidth='48px';mark.style.textAlign='right';btn.onclick=async e=>{e.stopPropagation();await play(xml,host)};row.onclick=()=>{if(answered)return;const ok=(audSig(xml)===audSig(qXML));row.classList.add(ok?'ok':'bad');if(!ok){mark.textContent='오답';mark.style.color='#dc2626';const cor=wrap.children[ci];if(cor){const tag=cor.querySelector('.mk')||document.createElement('div');tag.className='mk';tag.style.marginLeft='auto';tag.style.fontWeight='700';tag.style.color='#16a34a';tag.textContent='정답';cor.appendChild(tag)}S.reveal=true;if(!nextBtn){nextBtn=document.createElement('button');nextBtn.className='b';nextBtn.textContent='다음 문제';nextBtn.onclick=()=>{if(my===S.tok)newQ()};res.innerHTML='';res.appendChild(nextBtn)}return}answered=true;mark.textContent='정답';mark.style.color='#16a34a';res.textContent='✅ 정답! 다음 문제로 넘어갑니다...';setTimeout(()=>{if(my===S.tok)newQ()},1200)};row.appendChild(lab);row.appendChild(btn);row.appendChild(host);row.appendChild(mark);if(my===S.tok)wrap.appendChild(row)})};document.getElementById('unlock').addEventListener('click',async()=>{au();try{await A.ctx.resume()}catch(e){}tone(A.ctx.currentTime+.02,.2,880,.35)});[...document.querySelectorAll('.d')].forEach(b=>b.addEventListener('click',()=>{[...document.querySelectorAll('.d')].forEach(x=>x.classList.remove('a'));b.classList.add('a');S.sd=parseInt(b.dataset.sd,10);newQ()}));document.getElementById('newq').addEventListener('click',()=>newQ());window.addEventListener('load',()=>newQ());(function(){const map={4:8,8:4,16:2};[4,8,16].forEach(sd=>{const x=mk(sd),d=new DOMParser().parseFromString(x,'application/xml'),dd=[...d.getElementsByTagName('duration')].map(n=>parseInt(n.textContent||'0',10)),sum=dd.reduce((a,b)=>a+b,0);console.assert(sum===T,'sum!=32 '+sum+' sd='+sd);console.assert(dd.some(t=>t===map[sd]),'must include required tick sd='+sd);const hasNote=[...d.getElementsByTagName('note')].some(n=>!n.querySelector('rest'));console.assert(hasNote,'at least one note')})})();</script></body></html>
